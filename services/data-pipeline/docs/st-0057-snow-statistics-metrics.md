# [ST-0057] 历史降雪/积雪统计指标定义与口径确认

更新时间：2026-01-20

本文用于统一“历史降雪 / 积雪”统计口径，供后续实现（数据管线计算 + 图层渲染 + 测试验收）直接引用。

对应配置草案：`config/snow-statistics.yaml`

---

## 1. 术语与变量

### 1.1 术语

- **降雪量（snowfall, 新雪量）**：一段时间内落到地面的固态降水累积（常用单位：mm 水当量或 cm 雪深等价）。
- **积雪深度（snow depth）**：地面积雪的瞬时厚度（常用单位：cm）。

> 注意：降雪量与积雪深度不是同一概念；融雪、压实、风吹漂移都会影响积雪深度。

### 1.2 推荐变量命名（输出侧）

- `snowfall_sum_<window>`：窗口累计降雪量（mm 水当量）
- `snow_depth_max_<window>`：窗口最大积雪深度（cm）
- `snow_depth_pXX_<window>`：窗口内分位数（如 p10/p50/p90，cm）
- `snow_depth_anomaly_pctl_<window>`：异常百分位（0~100，表示“相对历史同季节/同月的百分位”）

---

## 2. 时间窗（窗口）定义

### 2.1 统计窗口（rolling）

用于“过去 N 天”查询/图层展示，推荐默认窗口：
- 7 天（短期）
- 30 天（中期）
- 90 天（季节尺度）

定义：
- 以 UTC 00:00 边界对齐到“日”（若源数据为小时/3小时，先日聚合）
- rolling 窗口默认按 **包含当日**：`[T-(N-1)day, T]`（共 N 个日样本）

### 2.2 历史基准（climatology）

用于“异常百分位/距平”等指标，推荐基准期：
- 1991–2020（若数据覆盖不足，可在配置中调整为可用年份段）

分组口径（优先级从高到低）：
1. **同日序（day-of-year）**：按 DOY 1..366 分组，允许 ±7 天平滑
2. **同月（monthly）**：按月份分组（实现简单但季节细节较弱）

---

## 3. 指标定义（口径）

### 3.1 窗口累计降雪量 `snowfall_sum_<window>`

目的：描述近期“新雪输入”强度。

推荐口径（两种实现路径，二选一，按数据源可用性配置）：

1) **直接变量法**（优先）：若源数据提供 `snowfall` 或 `solid_precip`，按日聚合后做窗口求和。

2) **派生法**：若只有总降水 `precip_amount` + 降水相态 `precip_type`：
- 先对每个时间步做“雪贡献”：
  - `snow_amount = precip_amount * I(precip_type == snow)`
  - 若存在 mix，可按约定比例拆分（默认 0.5）
- 再日聚合与窗口求和。

单位：
- 推荐统一到 **mm 水当量**；若源为 cm，则在派生/归一化阶段统一换算。

### 3.2 窗口最大积雪深度 `snow_depth_max_<window>`

目的：描述窗口内“最厚积雪”的强度，便于风险阈值判断。

口径：
- 以日尺度积雪深度序列为输入（如 `snow_depth_daily_mean` 或 `snow_depth_daily_max`，配置选择）
- rolling 窗口取 max。

单位：cm。

### 3.3 异常百分位 `snow_depth_anomaly_pctl_<window>`

目的：回答“当前（或窗口统计）在历史上属于什么水平”，用于事件归因与异常提示。

口径（示例：对 `snow_depth_max_7d` 计算异常百分位）：
- 基准集：基准期内同季节分组（DOY±7 天，或 monthly）
- 将当前值在该分布中的位置映射为百分位 `0..100`
- NaN 处理：若有效样本不足（例如 <30），输出 NaN 或回退到更粗的分组（月）

---

## 4. 数据源与优先级（建议）

建议在配置中明确优先级与变量映射（不同数据源字段名可能不同）：

1. **CLDAS**（如提供 snow depth / snow water equivalent / solid precip）
2. **ECMWF/ERA5**（作为补充或对照）
3. 业务历史归档（Archive dataset）

---

## 5. 输出与测试建议

### 5.1 输出形式（建议）

- 计算产物：NetCDF / Zarr（与现有 statistics 管线一致）
- 图层：按现有瓦片/切片策略输出（PNG/WebP），legend 配置沿用 `config/legend.json` 或新增 legend 文件

### 5.2 验收测试（建议）

- 单元测试：窗口定义（7/30/90）、聚合规则、单位归一化
- 统计健壮性：NaN 占比、极值范围、分位数单调性
- 回归样例：构造一个可重复的“人造雪季”数据，验证 anomaly 百分位随强度变化而单调

